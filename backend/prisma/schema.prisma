// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GlobalSettingStatus {
  enabled
  disabled
  beta
}

model User {
  address                String                   @id @unique
  name                   String?
  nonce                  String
  imageUrl               String?
  roles                  String[]                 @default(["ROLE_USER"])
  teams                  Team[]                   @relation("MemberTeams")
  ownedTeams             Team[]                   @relation("OwnedTeams")
  notifications          Notification[]
  BoardOfDirectorActions BoardOfDirectorActions[]
  memberTeamsData        MemberTeamsData[]
  Wage                   Wage[]
  weeklyClaims           WeeklyClaim[]
  Expense                Expense[]
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
}

model Team {
  id                     Int                      @id @default(autoincrement())
  members                User[]                   @relation("MemberTeams")
  owner                  User                     @relation("OwnedTeams", fields: [ownerAddress], references: [address], onDelete: Restrict)
  ownerAddress           String
  description            String?
  name                   String                   @unique
  officerAddress         String?
  BoardOfDirectorActions BoardOfDirectorActions[]
  teamContracts          TeamContract[]
  memberTeamsData        MemberTeamsData[]
  Wage                   Wage[]
  weeklyClaims           WeeklyClaim[]
  Expense                Expense[]
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  teamFunctionOverrides  TeamFunctionOverride[]
  safeAddress            String?
}

model MemberTeamsData {
  id            Int      @id @default(autoincrement()) // Add an ID for easy referencing
  member        User     @relation(fields: [memberAddress], references: [address], onDelete: Cascade)
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  memberAddress String
  teamId        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([memberAddress, teamId])
}

model Expense {
  id          Int      @id @default(autoincrement()) // Add an ID for easy referencing
  userAddress String
  teamId      Int
  signature   String
  data        Json
  status      String // e.g., "singed", "expired", "disabled"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userAddress], references: [address], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

model Wage {
  id                  Int           @id @default(autoincrement())
  team                Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user                User          @relation(fields: [userAddress], references: [address], onDelete: Cascade)
  teamId              Int
  userAddress         String
  ratePerHour         Json          @default("[{\"type\": \"cash\", \"amount\": 0},{\"type\": \"usdc\", \"amount\": 0},{\"type\": \"token\", \"amount\": 0}]")
  maximumHoursPerWeek Int
  nextWageId          Int?          @unique
  nextWage            Wage?         @relation("wageRelated", fields: [nextWageId], references: [id], onDelete: SetNull)
  previousWage        Wage?         @relation("wageRelated")
  claims              Claim[]
  weeklyClaims        WeeklyClaim[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@unique([teamId, userAddress, nextWageId]) // Need to be checked
}

model Claim {
  id              Int         @id @default(autoincrement()) // Add an ID for easy referencing
  hoursWorked     Int
  dayWorked       DateTime?
  memo            String?
  fileAttachments Json? // Stores file metadata and data for images and documents
  wageId          Int
  wage            Wage        @relation(fields: [wageId], references: [id], onDelete: Cascade)
  weeklyClaimId   Int
  weeklyClaim     WeeklyClaim @relation("WeeklyClaimToClaims", fields: [weeklyClaimId], references: [id], onDelete: Cascade)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model WeeklyClaim {
  id            Int      @id @default(autoincrement())
  status        String?
  weekStart     DateTime
  data          Json
  memberAddress String
  member        User     @relation(fields: [memberAddress], references: [address], onDelete: Cascade)
  teamId        Int
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  signature     String?
  claims        Claim[]  @relation("WeeklyClaimToClaims")
  wageId        Int
  wage          Wage     @relation(fields: [wageId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([wageId, weekStart])
}

model Notification {
  id          Int      @id @default(autoincrement())
  subject     String?
  message     String
  isRead      Boolean  @default(false)
  userAddress String
  user        User     @relation(fields: [userAddress], references: [address], onDelete: Cascade)
  author      String?
  resource    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamContract {
  id        Int      @id @default(autoincrement())
  address   String   @unique
  type      String
  deployer  String
  teamId    Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([address])
}

model BoardOfDirectorActions {
  id            Int      @id @default(autoincrement())
  actionId      Int
  description   String
  targetAddress String
  userAddress   String
  isExecuted    Boolean  @default(false)
  data          String
  createdBy     User     @relation(fields: [userAddress], references: [address], onDelete: Cascade)
  teamId        Int
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model GlobalSetting {
  id                    Int                    @id @default(autoincrement())
  functionName          String                 @unique
  status                GlobalSettingStatus    @default(disabled)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  teamFunctionOverrides TeamFunctionOverride[]
}

model TeamFunctionOverride {
  id            Int           @id @default(autoincrement())
  teamId        Int
  team          Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  functionName  String
  globalSetting GlobalSetting @relation(fields: [functionName], references: [functionName], onDelete: Cascade)
  status        String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([teamId, functionName], name: "unique_team_function")
  @@index([teamId])
}
