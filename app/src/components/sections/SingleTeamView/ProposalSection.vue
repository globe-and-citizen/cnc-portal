<template>
  <div v-if="team.votingAddress">
    <div v-if="team.votingAddress && !team.boardOfDirectorsAddress">
      <div class="flex justify-center">
        <button
          class="btn btn-primary btn-md"
          @click="executeDeployBoDContract(String(route.params.id), team.votingAddress)"
          v-if="
            !(isLoadingBoDDeployment || isLoadingSetBoardOfDirectorsContractAddress) &&
            !team.boardOfDirectorsAddress
          "
        >
          Deploy BoD Contract
        </button>
        <LoadingButton
          color="primary min-w-28"
          v-if="isLoadingBoDDeployment || isLoadingSetBoardOfDirectorsContractAddress"
        />
      </div>
    </div>
    <div v-else>
      <div class="flex flex-col" v-if="!loadingGetProposals" data-test="parent-div">
        <div class="flex justify-between">
          <div>
            <h2>Proposals</h2>
            <!-- <span
          class="badge badge-sm"
          :class="`${team.ownerAddress == useUserDataStore().address ? 'badge-primary' : 'badge-secondary'}`"
          >{{ team.bankAddress }}</span
        > -->
          </div>
          <div class="flex justify-between gap-4">
            <button class="btn btn-primary btn-md" @click="showModal = !showModal">
              Create Proposal
            </button>
            <button
              class="btn btn-secondary"
              v-if="team.boardOfDirectorsAddress"
              @click="
                () => {
                  executeGetBoardOfDirectors(String(team.boardOfDirectorsAddress))
                  showBoDModal = true
                }
              "
            >
              View BoD
            </button>
            <button class="btn btn-md btn-secondary" @click="showVotingControlModal = true">
              Manage
            </button>
          </div>
          <ModalComponent v-model="showVotingControlModal">
            <VotingManagement :team="team" />
          </ModalComponent>
        </div>
        <TabNavigation :initial-active-tab="0" :tabs="tabs" class="w-full">
          <template #tab-0>
            <ProposalCard
              v-for="proposal in activeProposals"
              :proposal="proposal"
              class="mt-10"
              :team="team"
              :key="proposal.title"
              @getTeam="emits('getTeam')"
            />
          </template>
          <template #tab-1>
            <ProposalCard
              v-for="proposal in oldProposals"
              :proposal="proposal"
              :team="team"
              :isDone="true"
              class="mt-10"
              :key="proposal.title"
            />
          </template>
        </TabNavigation>
        <ModalComponent v-model="showBoDModal">
          <h3>Board Of Directors</h3>
          <hr />
          <div class="mt-4">
            <ul v-if="boardOfDirectors?.length">
              <li
                v-for="(address, index) in boardOfDirectors"
                :key="index"
                class="text-sm flex justify-between"
              >
                <span v-if="team.members">
                  {{ team.members.find((member) => member.address === address)?.name || 'Unknown' }}
                </span>
                {{ address }}
              </li>
            </ul>
            <p v-else>No Board of Directors found.</p>
          </div>
        </ModalComponent>
        <ModalComponent v-model="showModal">
          <CreateProposalForm
            v-model="newProposalInput"
            @createProposal="createProposal"
            :isLoading="loadingAddProposal"
          />
        </ModalComponent>
      </div>
    </div>
    <div class="flex justify-center items-center" v-if="loadingGetProposals">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  </div>
  <div class="flex justify-center items-center" v-if="!team.votingAddress">
    <LoadingButton color="primary min-w-28" v-if="loadingDeployVotingContract" />
    <button
      v-else
      class="btn btn-primary btn-md"
      @click="executeVotingContract(String(route.params.id))"
    >
      Create Voting Contract
    </button>
  </div>
</template>
<script setup lang="ts">
import ProposalCard from '@/components/sections/SingleTeamView/ProposalCard.vue'
import type { Proposal } from '@/types/index'
import { onMounted, ref, watch } from 'vue'
import ModalComponent from '@/components/ModalComponent.vue'
import CreateProposalForm from '@/components/sections/SingleTeamView/forms/CreateProposalForm.vue'
import TabNavigation from '@/components/TabNavigation.vue'
import { ProposalTabs } from '@/types/index'
import {
  useAddProposal,
  useGetProposals,
  useDeployVotingContract,
  useSetBoardOfDirectorsContractAddress
} from '@/composables/voting'
import { useDeployBoDContract, useGetBoardOfDirectors } from '@/composables/bod'
import type { Team } from '@/types/index'
import { useRoute } from 'vue-router'
import { useToastStore } from '@/stores/useToastStore'
import LoadingButton from '@/components/LoadingButton.vue'
import VotingManagement from '@/components/sections/SingleTeamView/VotingManagement.vue'

const props = defineProps<{ team: Partial<Team> }>()
const showVotingControlModal = ref(false)
const emits = defineEmits(['getTeam'])
const { addSuccessToast, addErrorToast } = useToastStore()
const {
  boardOfDirectors,
  execute: executeGetBoardOfDirectors,
  error: errorGetBoardOfDirectors
} = useGetBoardOfDirectors()
const {
  execute: executeSetBoardOfDirectorsContractAddress,
  isLoading: isLoadingSetBoardOfDirectorsContractAddress,
  isSuccess: isSuccessSetBoardOfDirectorsContractAddress,
  error: errorSetBoardOfDirectorsContractAddress
} = useSetBoardOfDirectorsContractAddress()
watch(isSuccessSetBoardOfDirectorsContractAddress, () => {
  if (isSuccessSetBoardOfDirectorsContractAddress.value) {
    addSuccessToast('Board of directors contract address set successfully')
    emits('getTeam')
  }
})
watch(errorSetBoardOfDirectorsContractAddress, () => {
  if (errorSetBoardOfDirectorsContractAddress.value) {
    addErrorToast('Failed to set board of directors contract address')
  }
})
watch(errorGetBoardOfDirectors, () => {
  if (errorGetBoardOfDirectors.value) {
    addErrorToast('Failed to get board of directors')
  }
})

const {
  execute: executeVotingContract,
  isLoading: loadingDeployVotingContract,
  isSuccess: isSuccessDeployVotingContract,
  error: errorDeployVotingContract
} = useDeployVotingContract()
const {
  execute: executeDeployBoDContract,
  isLoading: isLoadingBoDDeployment,
  isSuccess: isSuccessBoDDeployment,
  contractAddress: boardOfDirectorsAddress
} = useDeployBoDContract()
watch(isSuccessBoDDeployment, () => {
  if (isSuccessBoDDeployment.value) {
    executeSetBoardOfDirectorsContractAddress(
      String(props.team.votingAddress),
      String(boardOfDirectorsAddress.value)
    )
  }
})
watch(errorDeployVotingContract, () => {
  if (errorDeployVotingContract.value) {
    addErrorToast('Failed to deploy voting contract')
  }
})
const {
  execute: executeAddProposal,
  isLoading: loadingAddProposal,
  isSuccess: isSuccessAddProposal,
  error: errorAddProposal
} = useAddProposal()
const {
  execute: executeGetProposals,
  isLoading: loadingGetProposals,
  isSuccess: isSuccessGetProposals,
  error: errorGetProposals,
  data: proposals
} = useGetProposals()
watch(isSuccessDeployVotingContract, () => {
  if (isSuccessDeployVotingContract.value) {
    emits('getTeam')
  }
})
watch(errorDeployVotingContract, () => {
  if (errorDeployVotingContract.value) {
    addErrorToast('Failed to deploy voting contract')
  }
})
watch(isSuccessGetProposals, () => {
  if (isSuccessGetProposals.value) {
    const proposalsList = Object.values(proposals.value)
    activeProposals.value = proposalsList.filter((proposal) => proposal.isActive)
    oldProposals.value = proposalsList.filter((proposal) => !proposal.isActive)
  }
})
watch(errorGetProposals, () => {
  if (errorGetProposals.value) {
    addErrorToast('Failed to get proposals')
  }
})
watch(isSuccessAddProposal, () => {
  if (isSuccessAddProposal.value) {
    addSuccessToast('Proposal created successfully')
    emits('getTeam')
  }
})
watch(errorAddProposal, () => {
  if (errorAddProposal.value) {
    addErrorToast('Failed to create proposal')
  }
})

const showModal = ref(false)
const showBoDModal = ref(false)
const tabs = ref([ProposalTabs.Ongoing, ProposalTabs.Done])

const route = useRoute()

const newProposalInput = ref<Partial<Proposal>>({
  title: '',
  description: '',
  isElection: false,
  voters: [],
  candidates: [],
  winnerCount: 0,
  teamId: Number(route.params.id)
})

const createProposal = () => {
  newProposalInput.value.voters = props.team.members?.map((member) => {
    return {
      name: member.name,
      memberAddress: member.address
    }
  })
  if (props.team.votingAddress) executeAddProposal(props.team.votingAddress, newProposalInput.value)
}
const oldProposals = ref<Partial<Proposal>[]>([])
const activeProposals = ref<Partial<Proposal>[]>([])

onMounted(() => {
  if (props.team.votingAddress) executeGetProposals(props.team.votingAddress)
})
</script>
