name: Frontend E2E Synpress Playwright

permissions:
  contents: read

on:
  pull_request:
    branches: ["**"]
    paths:
      - "app/**"
      - ".github/workflows/app-e2e.yml"
  workflow_dispatch:

jobs:
  app-e2e-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ›« Checkout
        uses: actions/checkout@v4

      - name: ðŸ— Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"
          cache-dependency-path: ./app/package-lock.json

      - name: ðŸ“¦ Install dependencies
        run: npm ci
        working-directory: ./app

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install chromium --with-deps
        working-directory: ./app

      - name: â›“ï¸ Install Hardhat and dependencies
        run: npm ci
        working-directory: ./contract

      - name: â›“ï¸ Start Local Blockchain (Hardhat Node)
        run: |
          npx hardhat node > hardhat.log 2>&1 &
          HARDHAT_PID=$!
          # Wait for Hardhat node to be ready
          timeout 30 bash -c 'until curl -s http://127.0.0.1:8545 -X POST -d "{\"jsonrpc\":\"2.0\",\"method\":\"net_version\",\"params\":[],\"id\":1}" > /dev/null 2>&1; do sleep 0.5; done'
          echo "Hardhat node started with PID: $HARDHAT_PID"
          sleep 30
        working-directory: ./contract

      - name: ðŸ’¾ Build Synpress Cache
        run: npm run test:build:cache
        working-directory: ./app
        env:
          HEADLESS: true

      - name: ðŸŒŽ Start Frontend Dev Server
        run: |
          VITE_APP_NETWORK_ALIAS=hardhat npm run dev > vite.log 2>&1 &
          VITE_PID=$!
          sleep 20
          timeout 60 bash -c 'until curl -s http://localhost:5173 > /dev/null; do sleep 1; done'
          echo "Vite dev server started with PID: $VITE_PID"
          sleep 30
        working-directory: ./app

      - name: ðŸ§ª Run E2E Tests
        run: npm run test:e2e
        working-directory: ./app
        env:
          CI: true
          HEADLESS: true

      - name: ðŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: app/playwright-report/
          retention-days: 30

      - name: ðŸ“ˆ Upload Test Traces
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: app/test-results/
          retention-days: 7
